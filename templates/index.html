<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Census Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; }
    body { display: flex; flex-direction: column; background: #f8f9fa; }
    #chat-area {
      flex: 1; overflow-y: auto; padding: 1rem 1rem 0.5rem;
    }
    .bubble { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.75rem; word-wrap: break-word; }
    .bubble-user { background: #0d6efd; color: #fff; margin-left: auto; border-bottom-right-radius: 0.25rem; }
    .bubble-assistant { background: #e9ecef; color: #212529; margin-right: auto; border-bottom-left-radius: 0.25rem; }
    .bubble-assistant pre { background: #dee2e6; padding: 0.5rem; border-radius: 0.375rem; overflow-x: auto; }
    .bubble-assistant table { font-size: 0.85rem; }
    .step-error { color: #dc3545; font-weight: 500; }
    #input-bar { background: #fff; border-top: 1px solid #dee2e6; padding: 0.75rem 1rem; }
    #suggestions { padding: 0.5rem 1rem; }
    .suggestion-btn { font-size: 0.85rem; }
    #spinner { display: none; }
  </style>
</head>
<body>

  <!-- Header -->
  <nav class="navbar navbar-light bg-white border-bottom px-3">
    <span class="navbar-brand mb-0 h5">&#x1F4CA; Census Chat</span>
    <button id="reset-btn" class="btn btn-outline-secondary btn-sm">Reset</button>
  </nav>

  <!-- Suggestions -->
  <div id="suggestions" class="d-flex flex-wrap gap-2">
    <small class="text-muted w-100">Try a question:</small>
    <button class="btn btn-outline-primary btn-sm suggestion-btn">Which states have the longest average commute times?</button>
    <button class="btn btn-outline-primary btn-sm suggestion-btn">Where do renters spend over 30% of income on rent?</button>
    <button class="btn btn-outline-primary btn-sm suggestion-btn">Which states have the highest percentage of people who moved from another state?</button>
    <button class="btn btn-outline-primary btn-sm suggestion-btn">What percentage of the population speaks a language other than English at home, by state?</button>
  </div>

  <!-- Chat area -->
  <div id="chat-area"></div>

  <!-- Spinner -->
  <div id="spinner" class="text-center py-2">
    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
    <small class="text-muted ms-2">Thinking...</small>
  </div>

  <!-- Input bar -->
  <div id="input-bar">
    <form id="chat-form" class="d-flex gap-2">
      <input id="user-input" type="text" class="form-control" placeholder="Ask a question about US census data..." autocomplete="off">
      <button type="submit" class="btn btn-primary">Send</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const chatArea  = document.getElementById('chat-area');
    const chatForm  = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const spinner   = document.getElementById('spinner');
    const resetBtn  = document.getElementById('reset-btn');
    const suggestions = document.getElementById('suggestions');

    function scrollBottom() {
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function addBubble(role, html) {
      const div = document.createElement('div');
      div.className = 'bubble bubble-' + role;
      div.innerHTML = html;
      chatArea.appendChild(div);
      scrollBottom();
    }

    function renderSteps(steps) {
      let html = '';
      for (const step of steps) {
        switch (step.type) {
          case 'answer':
          case 'llm_response':
            html += marked.parse(step.content);
            break;
          case 'query_result':
            html += renderTable(step.content);
            break;
          case 'query_error':
            html += '<p class="step-error">Query error: ' + escapeHtml(step.content) + '</p>';
            break;
          case 'error':
            html += '<p class="step-error">' + escapeHtml(step.content) + '</p>';
            break;
        }
      }
      return html;
    }

    function renderTable(rows) {
      if (!rows || rows.length === 0) return '<p class="text-muted">(no results)</p>';
      const cols = Object.keys(rows[0]);
      let t = '<div class="table-responsive"><table class="table table-sm table-bordered mt-2 mb-2">';
      t += '<thead class="table-light"><tr>' + cols.map(c => '<th>' + escapeHtml(c) + '</th>').join('') + '</tr></thead><tbody>';
      for (const row of rows) {
        t += '<tr>' + cols.map(c => '<td>' + escapeHtml(String(row[c] ?? '')) + '</td>').join('') + '</tr>';
      }
      t += '</tbody></table></div>';
      return t;
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    async function sendMessage(text) {
      if (!text.trim()) return;
      addBubble('user', escapeHtml(text));
      userInput.value = '';
      suggestions.style.display = 'none';
      spinner.style.display = 'block';
      scrollBottom();

      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text }),
        });
        const data = await res.json();
        if (data.steps) {
          addBubble('assistant', renderSteps(data.steps));
        } else if (data.error) {
          addBubble('assistant', '<p class="step-error">' + escapeHtml(data.error) + '</p>');
        }
      } catch (err) {
        addBubble('assistant', '<p class="step-error">Network error: ' + escapeHtml(err.message) + '</p>');
      } finally {
        spinner.style.display = 'none';
      }
    }

    chatForm.addEventListener('submit', e => {
      e.preventDefault();
      sendMessage(userInput.value);
    });

    document.querySelectorAll('.suggestion-btn').forEach(btn => {
      btn.addEventListener('click', () => sendMessage(btn.textContent));
    });

    resetBtn.addEventListener('click', async () => {
      await fetch('/reset', { method: 'POST' });
      chatArea.innerHTML = '';
      suggestions.style.display = 'flex';
    });
  </script>
</body>
</html>
